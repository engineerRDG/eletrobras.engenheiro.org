<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Operacional - Vilhena Serviços</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
    /* Estilos Gerais */
    body {
    background-color: #f0f2f5;
    color: #343a40;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    main {
    flex-grow: 1;
    }
    .navbar-brand img, .footer-logo {
    height: 40px;
    width: auto;
    }
    .page-title {
    font-weight: 700;
    color: #343a40;
    }
    .content-section {
    display: none;
    }
    .content-section.active {
    display: block;
    }

    /* Cartões de Navegação */
    .nav-card {
    background-color: #ffff;
    border: 2px solid transparent;
    border-radius: .5rem;
    box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.15);
    transition: all 0.2s ease-in-out;
    text-decoration: none;
    color: inherit;
    height: 100%;
    }
    .nav-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
    }
    .nav-card.active {
    border-color: #0d6efd;
    box-shadow: 0 0 0 .2rem rgba(13, 110, 253, .25);
    }
    .nav-card .card-body { 
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 170px;
    }
    .nav-card-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .nav-card-icon svg {
    width: 2.5rem;
    height: 2.5rem;
    }

    .nav-card-title { font-weight: 700; font-size: 1.1rem; }

    /* --- Estilos da Seção STATUS --- */
    .status-card {
    border: 1px solid #dee2e6;
    border-left-width: 5px;
    border-radius: .35rem;
    box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.15);
    background-color: #ffff;
    display: flex; flex-direction: column;
    }
    .status-card .card-body { padding: 1.5rem; display: flex; flex-direction: column; flex-grow: 1; justify-content: center; }
    .status-content { text-align: center; }
    .status-title { font-weight: 700; font-size: 1.1rem; text-transform: uppercase; margin-bottom: 0.5rem; }
    .status-text { font-size: 1.6rem; font-weight: 700; margin: 0.5rem 0; }
    .status-condition { font-size: 1.1rem; font-weight: 500; color: #6c757d; margin-bottom: 0.5rem; }
    .status-operando { border-left-color: #28a745; }
    .status-disponivel { border-left-color: #17a2b8; }
    .status-manutencao { border-left-color: #dc3545; }
    .status-paralisada { border-left-color: #6c757d; }
    .loading-spinner { display: none; text-align: center; padding: 2rem; }
    .loading-spinner.active { display: block; }
    
    /* --- Estilos da Seção FROTA --- */
    .reservoir-title { border-bottom: 2px solid; padding-bottom: 0.5rem; }
    .vessel-card {
    border: 1px solid #dee2e6;
    border-left: 5px solid;
    border-radius: .35rem;
    box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.15);
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    background-color: #ffff;
    cursor: pointer;
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    padding: 1rem; min-height: 140px;
    text-align: center;
    }
    .vessel-card:hover { transform: translateY(-5px); }
    .vessel-card .card-title { font-weight: 700; font-size: 1.1rem; color: #343a40; margin-bottom: 0.2rem; display: flex; align-items: center; gap: 8px; }
    .vessel-card .card-title i { color: #6c757d; }
    .vessel-card .card-city { font-size: 0.9rem; color: #6c757d; }
    .vessel-card .card-type { font-size: 0.8rem; font-weight: 600; color: #0d6efd; margin-top: 5px; }
    .reservoir-title-furnas { border-bottom-color: #198754; color: #198754; }
    .vessel-card-furnas { border-left-color: #198754; }
    .vessel-card-furnas:hover { box-shadow: 0 .5rem 1rem rgba(25, 135, 84, .25); }
    .reservoir-title-mascarenhas { border-bottom-color: #0d6efd; color: #0d6efd; }
    .vessel-card-mascarenhas { border-left-color: #0d6efd; }
    .vessel-card-mascarenhas:hover { box-shadow: 0 .5rem 1rem rgba(13, 110, 253, .25); }
    .modal-vessel-image {
    max-width: 100%;
    height: auto;
    max-height: 220px;
    border-radius: .25rem;
    object-fit: cover;
    margin-bottom: 1.5rem;
    display: block;
    margin-left: auto;
    margin-right: auto;
    }

    /* --- Estilos da Seção CRONOGRAMA --- */
    .schedule-container {
    background-color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden; padding: 1.5rem;
    }
    .schedule-table { width: 100%; border-collapse: collapse; }
    .schedule-table th, .schedule-table td { border: 1px solid #dee2e6; padding: 8px; text-align: center; vertical-align: top; }
    .schedule-table thead th { background-color: #191c1f; color: #ffff; padding: 12px; }
    .schedule-table tbody td { min-height: 150px; }
    .schedule-event { color: white; padding: 8px; border-radius: 6px; margin-bottom: 8px; text-align: left; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s ease; }
    .event-title { font-weight: bold; display: block; }
    .event-details { font-size: 0.9em; display: block; margin-top: 4px; }
    .event-technician { font-style: italic; }
    .event-carlos { background-color: #198754; } .event-carlos:hover { background-color: #157347; }
    .event-juliana { background-color: #dc3545; } .event-juliana:hover { background-color: #b02a37; }
    .event-fernando { background-color: #ffc107; color: #000; } .event-fernando:hover { background-color: #e0a800; }
    .event-default { background-color: #404550; } .event-default:hover { background-color: #6b7688; }
    .schedule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-black shadow-sm">
    <div class="container-fluid d-flex justify-content-between">
    <a class="navbar-brand" href="#" id="home-link">
    <img src="https://raw.githubusercontent.com/engineerRDG/vilhena.engenheiro.org/refs/heads/main/imagem/logo.png" alt="Vilhena Serviços Logo">
    </a>
    <span class="navbar-text text-white">
    <b>TC 8000014022</b>
    </span>
    </div>
    </nav>

    <main class="container mt-4">

    <section id="main-menu">
    <header class="text-center mb-4">
    <h1 class="page-title">CONTROLE OPERACIONAL</h1>
    <p class="lead text-muted">Selecione uma opção para visualizar as informações.</p>
    </header>
    <div class="row text-center g-4 justify-content-center">
    <div class="col-lg-3 col-md-5">
    <a href="#" class="card nav-card" data-target="status-section">
    <div class="card-body">
    <div class="nav-card-icon"><i class="bi bi-water"></i></div>
    <h3 class="nav-card-title">Cássia ⮂ Delfinópolis</h3>
    </div>
    </a>
    </div>
    <div class="col-lg-3 col-md-5">
    <a href="#" class="card nav-card" data-target="frota-section">
    <div class="card-body">
    <div class="nav-card-icon">
    <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
    <path d="M12 36h16l4 8H8z" fill="currentColor"></path>
    <path d="M28 26h16l4 8H24z" fill="currentColor" opacity="0.8"></path>
    <path d="M44 18h16l4 8H40z" fill="currentColor" opacity="0.6"></path>
    <path d="M6 48c4 2 8 2 12 0s8-2 12 0 8 2 12 0 8-2 12 0" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"></path>
    </svg>
    <span class="visually-hidden">Ícone representando múltiplas embarcações</span>
    </div>
    <h3 class="nav-card-title">Embarcações</h3>
    </div>
    </a>
    </div>
    <div class="col-lg-3 col-md-5">
    <a href="#" class="card nav-card" data-target="cronograma-section">
    <div class="card-body">
    <div class="nav-card-icon"><i class="bi bi-calendar-event-fill"></i></div>
    <h3 class="nav-card-title">Cronograma de Atendimento</h3>
    </div>
    </a>
    </div>
    </div>
    </section>

    <div id="content-container" class="mt-5">
    <section id="status-section" class="content-section">
    <header class="d-flex justify-content-end mb-4 pb-2 border-bottom">
    <div id="sheet-update-info" class="text-muted text-end"></div>
    </header>
    <div class="loading-spinner" id="loading-spinner">
    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
    <p class="mt-3 text-muted">Buscando informações da planilha...</p>
    </div>
    <div id="status-container" class="row g-4"></div>
    </section>

    <section id="frota-section" class="content-section">
    <div id="frota-container">
    <section id="furnas-section" class="mb-5">
    <h2 class="h4 reservoir-title reservoir-title-furnas mb-4">Reservatório da Usina de Furnas</h2>
    <div id="furnas-container" class="row g-3"></div>
    </section>
    <section id="mascarenhas-section" class="mb-5">
    <h2 class="h4 reservoir-title reservoir-title-mascarenhas mb-4">Reservatório da Usina de Mascarenhas de Moraes</h2>
    <div id="mascarenhas-container" class="row g-3"></div>
    </section>
    </div>
    </section>

    <section id="cronograma-section" class="content-section">
    <div class="schedule-container">
    <div class="schedule-header">
    <a href="#" class="btn btn-outline-primary" id="prev-week-btn"><i class="bi bi-arrow-left-short"></i> Semana Anterior</a>
    <h2 class="h4 mb-0 text-center" id="schedule-week-range">Carregando semana...</h2>
    <a href="#" class="btn btn-outline-primary" id="next-week-btn">Próxima Semana <i class="bi bi-arrow-right-short"></i></a>
    </div>
    <div class="table-responsive">
    <table class="schedule-table">
    <thead id="schedule-table-head"></thead>
    <tbody id="schedule-table-body"></tbody>
    </table>
    </div>
    </div>
    </section>
    </div>
    </main>
    
    <i href="https://rodrigo.engenheiro.org"><footer class="container mt-5 mb-4 d-flex flex-wrap justify-content-between align-items-center border-top pt-4" href="https://rodrigo.engenheiro.org" >
    <img src="https://raw.githubusercontent.com/engineerRDG/vilhena.engenheiro.org/refs/heads/main/imagem/eletrobras.png" alt="Logo Eletrobras" class="footer-logo">
    <div class="text-end" href="https://rodrigo.engenheiro.org">
    <p class="text-muted mb-1" style="font-size: 0.9rem;"><b>Vilhena Serviços LTDA</b><br>Departamento de Engenharia e Manutenção</p>
    <p class="text-body-tertiary mb-0" style="font-size: 0.6rem;"><b>Rodrigo M. Araujo</b><br>Engenheiro Mecânico<br>
    Engenheiro de Segurança do Trabalho
    <br>
<b>rodrigo@engenheiro.org</b>
    <br>
<b>(91) 98456-5209</b>
</p>
    </div>
    </footer>
    </i>

    <div class="modal fade" id="vesselDetailsModal" tabindex="-1" aria-labelledby="vesselDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
    <div class="modal-header">
    <h5 class="modal-title" id="vesselDetailsModalLabel">Detalhes da Embarcação</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
    <div class="text-center mb-4">
    <h4 id="modalVesselName" class="mb-1 text-primary"></h4>
    <p id="modalVesselCity" class="text-muted"></p>
    <img id="modalVesselImage" src="" alt="Imagem da Embarcação" class="modal-vessel-image img-fluid">
    </div>
    <div id="modalPranchaInfo" class="alert alert-danger text-center" style="display: none;">
    Embarcação do tipo Prancha não possui sistema de propulsão
    </div>
    <div id="modalComponentStatus" class="details-section text-start mt-4">
    <h6><i class="bi bi-clipboard-data"></i> Status dos Componentes</h6>
    <ul class="list-group">
    <li class="list-group-item d-flex justify-content-between align-items-center">
    <span><i class="bi bi-gear-fill text-muted"></i> Motores</span>
    <div><strong id="modalMotorStatusBE">N/A</strong> / <strong id="modalMotorStatusBB">N/A</strong></div>
    </li>
    <li class="list-group-item d-flex justify-content-between align-items-center">
    <span><i class="bi bi-arrow-repeat text-muted"></i> Reversores</span>
    <div><strong id="modalReversorStatusBE">N/A</strong> / <strong id="modalReversorStatusBB">N/A</strong></div>
    </li>
    </ul>
    </div>
    <div id="modalTechnicalInfo" class="details-section text-start mt-4">
    <h6><i class="bi bi-info-circle-fill"></i> Informações Técnicas</h6>
    <ul class="list-group list-group-flush">
    <li class="list-group-item"><strong>Motor:</strong> <span id="modalMotorInfo">N/A</span></li>
    <li class="list-group-item"><strong>Reversor:</strong> <span id="modalReversorInfo">N/A</span></li>
    </ul>
    </div>
    </div>
    </div>
    </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    // --- LÓGICA DE NAVEGAÇÃO GERAL ---
    const navCards = document.querySelectorAll('.nav-card');
    const contentSections = document.querySelectorAll('.content-section');
    const homeLink = document.getElementById('home-link');

    function showSection(targetId, clickedCard) {
    navCards.forEach(card => card.classList.remove('active'));
    if (clickedCard) clickedCard.classList.add('active');

    contentSections.forEach(section => {
    section.classList.toggle('active', section.id === targetId);
    });

    if (targetId) {
    const initFunctionName = `init${targetId.charAt(0).toUpperCase() + targetId.slice(1).replace('-section', '')}Module`;
    if (typeof window[initFunctionName] === 'function') {
    window[initFunctionName]();
    }
    }
    }

    navCards.forEach(card => {
    card.addEventListener('click', (event) => {
    event.preventDefault();
    const targetSectionId = card.getAttribute('data-target');
    showSection(targetSectionId, card);
    });
    });
    
    homeLink.addEventListener('click', (event) => {
    event.preventDefault();
    showSection(null, null);
    });
});

    // --- MÓDULO DE STATUS ---
    window.initStatusModule = function() {
    const statusContainer = document.getElementById('status-container');
    if (statusContainer.dataset.initialized) return;
    statusContainer.dataset.initialized = 'true';

    const apiUrl = 'https://script.google.com/macros/s/AKfycbxiLSh45xdBYElGcFKesxv14_9bbGD3LnB_N2n8B3L4xPmX87IABWPvWQehaSEnNOM/exec';
    const elements = { 
    statusContainer: statusContainer, 
    sheetUpdateInfo: document.getElementById('sheet-update-info'), 
    loadingSpinner: document.getElementById('loading-spinner') 
    };

    async function fetchData() {
    elements.loadingSpinner.classList.add('active');
    elements.statusContainer.innerHTML = '';
    try {
    const response = await fetch(`${apiUrl}?t=${new Date().getTime()}`);
    if (!response.ok) throw new Error(`Falha na rede (código: ${response.status})`);
    const data = await response.json();
    if (data.error) throw new Error(data.error);
    if (data[0]?.ULTIMA_ATUALIZACAO) {
    elements.sheetUpdateInfo.innerHTML = `<small class="d-block">Última atualização:</small><strong>${data[0]['ULTIMA_ATUALIZACAO']}</strong>`;
    }
    updateStatusCards(data);
    } catch (error) {
    console.error("Erro em Status:", error);
    elements.statusContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger"><strong>Erro:</strong> ${error.message}</div></div>`;
    } finally {
    elements.loadingSpinner.classList.remove('active');
    }
    }

    function updateStatusCards(data) {
    if (!data || data.length === 0) {
    elements.statusContainer.innerHTML = `<div class="col-12"><div class="alert alert-warning">Nenhum dado encontrado.</div></div>`;
    return;
    }
    data.forEach(item => {
    if (item.STATUS === 'MANUTENCAO') item.STATUS = 'MANUTENÇÃO';
    if (item.STATUS === 'DISPONIVEL') item.STATUS = 'DISPONÍVEL';
    });
    data.sort((a, b) => {
    const order = { 'OPERANDO': 1, 'DISPONÍVEL': 2, 'MANUTENÇÃO': 3 };
    return (order[a.STATUS] || 4) - (order[b.STATUS] || 4) || (a.EMBARCACAO || '').localeCompare(b.EMBARCACAO || '');
    });
    elements.statusContainer.innerHTML = data.map(item => {
    const status = (item.STATUS || 'PARALISADA').replace('ÇÃO', 'CAO').replace('Í', 'I').toLowerCase();
    return `<div class="col-xl-4 col-md-6 mb-4">
    <div class="card status-card status-${status}">
    <div class="card-body">
    <div class="status-content">
    <div class="status-title">${item.EMBARCACAO || 'Sem Nome'}</div>
    <div class="status-text">${item.STATUS || 'PARALISADA'}</div>
    ${item.CONDICAO ? `<div class="status-condition">${item.CONDICAO}</div>` : ''}
    </div>
    </div>
    </div>
    </div>`;
    }).join('');
    }

    fetchData();
    if (window.statusInterval) clearInterval(window.statusInterval);
    window.statusInterval = setInterval(fetchData, 60000);
    }

    // --- MÓDULO DA FROTA ---
    window.initFrotaModule = function() {
    const frotaContainer = document.getElementById('frota-container');
    if (frotaContainer.dataset.initialized) return;
    frotaContainer.dataset.initialized = 'true';
    
    const dadosDaFrota = [
    { "embarcação": "Águas Verdes", "cidade": "Carmo do Rio Claro", "tipo": "Ferry Boat", "motor bb": "MWM 229/6 aspirado", "reversor bb": "ZF BW 40", "motor be": "MWM 229/6 aspirado", "reversor be": "ZF BW 40", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/%C3%81guas%20Verdes.jpg"},
    { "embarcação": "Araúna", "cidade": "Fama", "tipo": "Ferry Boat", "motor bb": "MWM 229/6", "reversor bb": "ZF 40", "motor be": "MWM 229/6", "reversor be": "ZF 40", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/Arauna.jpg"},
    { "embarcação": "Canastra", "cidade": "Delfinópolis", "tipo": "Prancha", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/Canastra.jpg"},
    { "embarcação": "Delfinópolis I", "cidade": "Delfinópolis", "tipo": "Ferry Boat", "motor bb": "Mercedes-Benz 352", "reversor bb": "ZF BW 40", "motor be": "Mercedes-Benz 352", "reversor be": "ZF BW 40", "imagemUrl": "https://raw.githubusercontent.com/google-gemini/cookbook/main/examples/data/ferry2.jpg"},
    { "embarcação": "Fama", "cidade": "Alfenas", "tipo": "Ferry Boat", "motor bb": "MWM 229/6 aspirado", "reversor bb": "ZF BW 40", "motor be": "MWM 229/6 aspirado", "reversor be": "ZF BW 40", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/FAMA.jpg"},
    { "embarcação": "Fernandes", "cidade": "Cristais", "tipo": "Ferry Boat", "motor bb": "Mercedes-Benz OM 352", "reversor bb": "ZF BW 40", "motor be": "Mercedes-Benz OM 352", "reversor be": "ZF BW 40", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/Fernandes.jpg"},
    { "embarcação": "Guapé", "cidade": "Guapé", "tipo": "Ferry Boat", "motor bb": "MWM 229/6", "reversor bb": "ZF BW 40", "motor be": "MWM 229/6", "reversor be": "ZF BW 40", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/Guap%C3%A9.jpg"},
    { "embarcação": "Harmonia", "cidade": "Guapé", "tipo": "Ferry Boat", "motor bb": "MWM 229/6 aspirado", "reversor bb": "ZF BW 40", "motor be": "MWM 229/6 aspirado", "reversor be": "ZF BW 40", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/Harmonia.jpg"},
    { "embarcação": "Itapiché", "cidade": "Carmo do Rio Claro", "tipo": "Ferry Boat", "motor bb": "MWM 229/6 aspirado", "reversor bb": "ZF 40", "motor be": "MWM 229/6 aspirado", "reversor be": "ZF 40", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/Itapich%C3%A9.jpg"},
    { "embarcação": "Nossa Senhora dos Navegantes VII", "cidade": "Delfinópolis", "tipo": "Rebocador", "motor bb": "Scania P94", "reversor bb": "Tramontine RT410 3:1", "motor be": "Scania P94", "reversor be": "Tramontine RT410 3:1", "imagemUrl": "https://raw.githubusercontent.com/google-gemini/cookbook/main/examples/data/ferry2.jpg"},
    { "embarcação": "Nossa Senhora dos Navegantes X", "cidade": "Delfinópolis", "tipo": "Rebocador", "motor bb": "Scania DS-11", "reversor bb": "Tramontine RT 410 3:1", "motor be": "Scania DS-11", "reversor be": "Tramontine RT 410 3:1", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/NSDN%20X.jpg"},
    { "embarcação": "Pontalete", "cidade": "Três Pontas", "tipo": "Ferry Boat", "motor bb": "MWM 229/6 aspirado", "reversor bb": "ZF BW 40", "motor be": "MWM 229/6 aspirado", "reversor be": "HURTH HSW 630 H1", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/Pontalete.jpg"},
    { "embarcação": "Rio Grande 2005", "cidade": "Delfinópolis", "tipo": "Ferry Boat", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/Rio%20Grande%202005.jpg"},
    { "embarcação": "Rio Grande IV", "cidade": "Delfinópolis", "tipo": "Ferry Boat", "motor bb": "MWM 229/06 aspirado (2)", "reversor bb": "ZF 220 (2)", "motor be": "MWM 229/06 aspirado (2)", "reversor be": "ZF 220 (2)", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/Rio%20Grande%20IV.jpg"},
    { "embarcação": "Saliba", "cidade": "Campo Belo", "tipo": "Ferry Boat", "motor bb": "OK", "reversor bb": "OK", "motor be": "OK", "reversor be": "OK", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/Saliba.jpg"},
    { "embarcação": "São Francisco I", "cidade": "Guapé", "tipo": "Ferry Boat", "motor bb": "MWM 229/6", "reversor bb": "ZF BW 40", "motor be": "MWM 229/6", "reversor be": "ZF BW 40", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/S%C3%A3o%20Francisco%20I.jpg"},
    { "embarcação": "São Francisco III", "cidade": "Campo do Meio", "tipo": "Ferry Boat", "motor bb": "Mercedes-Benz OM 352", "reversor bb": "ZF BW 40", "motor be": "Mercedes-Benz OM 352", "reversor be": "ZF BW 40", "imagemUrl": "https://raw.githubusercontent.com/engineerRDG/eletrobras.engenheiro.org/refs/heads/main/imagem/embarca%C3%A7%C3%B5es/S%C3%A3o%20Francisco%20III.jpg"},
    ];

    const elements = {
    furnas: document.getElementById('furnas-container'), 
    mascarenhas: document.getElementById('mascarenhas-container'),
    modal: new bootstrap.Modal(document.getElementById('vesselDetailsModal')),
    img: document.getElementById('modalVesselImage'), name: document.getElementById('modalVesselName'), city: document.getElementById('modalVesselCity'), 
    motorStatusBE: document.getElementById('modalMotorStatusBE'), motorStatusBB: document.getElementById('modalMotorStatusBB'),
    reversorStatusBE: document.getElementById('modalReversorStatusBE'), reversorStatusBB: document.getElementById('modalReversorStatusBB'),
    motorInfo: document.getElementById('modalMotorInfo'), reversorInfo: document.getElementById('modalReversorInfo'),
    pranchaInfo: document.getElementById('modalPranchaInfo'), componentStatus: document.getElementById('modalComponentStatus'), technicalInfo: document.getElementById('modalTechnicalInfo')
    };

    const allVesselsData = dadosDaFrota.map((item, index) => ({
    ...item,
    id: `vessel-${index}`,
    reservoir: (item.cidade && item.cidade.trim() === 'Delfinópolis') ? 'Mascarenhas' : 'Furnas'
    }));

    const getProp = (obj, key) => obj[Object.keys(obj).find(k => k.toLowerCase() === key.toLowerCase())];

    function generateCards(data) {
    if (!data.length) return `<div class="col-12"><div class="alert alert-light text-center">Nenhuma embarcação encontrada.</div></div>`;
    return data.sort((a, b) => getProp(a, 'embarcação').localeCompare(getProp(b, 'embarcação')))
    .map(item => `<div class="col-lg-3 col-md-4 col-sm-6 mb-4">
    <div class="card vessel-card vessel-card-${item.reservoir.toLowerCase()}" data-vessel-id="${item.id}">
    <div class="card-title"><i class="bi bi-ship-fill"></i> ${getProp(item, 'embarcação')}</div>
    <div class="card-city">${getProp(item, 'cidade')}</div>
    <div class="card-type">${getProp(item, 'tipo') || ''}</div>
    </div>
    </div>`).join('');
    }

    elements.furnas.innerHTML = generateCards(allVesselsData.filter(v => v.reservoir === 'Furnas'));
    elements.mascarenhas.innerHTML = generateCards(allVesselsData.filter(v => v.reservoir === 'Mascarenhas'));

    document.querySelectorAll('.vessel-card').forEach(card => card.addEventListener('click', () => {
    const vessel = allVesselsData.find(v => v.id === card.dataset.vesselId);
    if (!vessel) return;

    const imageUrl = getProp(vessel, 'imagemUrl');
    elements.img.style.display = imageUrl ? 'block' : 'none';
    elements.img.src = imageUrl || '';

    elements.name.textContent = getProp(vessel, 'embarcação');
    elements.city.textContent = getProp(vessel, 'cidade');

    if (getProp(vessel, 'tipo') === 'Prancha') {
    elements.pranchaInfo.style.display = 'block';
    elements.componentStatus.style.display = 'none';
    elements.technicalInfo.style.display = 'none';
    } else {
    elements.pranchaInfo.style.display = 'none';
    elements.componentStatus.style.display = 'block';
    elements.technicalInfo.style.display = 'block';
    elements.motorStatusBE.textContent = getProp(vessel, 'motor be') || 'N/A';
    elements.motorStatusBB.textContent = getProp(vessel, 'motor bb') || 'N/A';
    elements.reversorStatusBE.textContent = getProp(vessel, 'reversor be') || 'N/A';
    elements.reversorStatusBB.textContent = getProp(vessel, 'reversor bb') || 'N/A';
    elements.motorInfo.textContent = getProp(vessel, 'motorInfo') || 'Não especificado';
    elements.reversorInfo.textContent = getProp(vessel, 'reversorInfo') || 'Não especificado';
    }
    
    elements.modal.show();
    }));
    }

    // --- MÓDULO DO CRONOGRAMA (SOLUÇÃO DEFINITIVA) ---
    window.initCronogramaModule = async function() {
    const scheduleContainer = document.getElementById('cronograma-section');
    if (scheduleContainer.dataset.initialized) return;
    scheduleContainer.dataset.initialized = 'true';

    let currentDate = new Date();
    const weekRangeEl = document.getElementById('schedule-week-range');
    const tableHeadEl = document.getElementById('schedule-table-head');
    const tableBodyEl = document.getElementById('schedule-table-body');
    const prevBtn = document.getElementById('prev-week-btn');
    const nextBtn = document.getElementById('next-week-btn');
    const locale = 'pt-BR';
    
    // ### PASSO 1: URL CORRETA DA PLANILHA (3 COLUNAS) ###
    // Este é o link para a planilha com a estrutura da imagem (data, titulo, descricao)
    const scheduleApiUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTu9skDnnYmILUpQ4UvWblPFbq1D4k7Dy4FPK5k-21kgAurdYAJbxyXhbofQGUDHwSefc6w18tDOqPj/pub?gid=502983351&single=true&output=csv';
    let allScheduleData = [];

    const technicianColors = {
    'CARLOS': 'carlos',
    'JULIANA': 'juliana',
    'FERNANDO': 'fernando',
    'EDGAR': 'carlos', // Mapeando Edgar para a cor 'carlos'
    };

    function parseCsvLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"' && (i === 0 || line[i-1] !== '\\')) {
    inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
    result.push(current.trim());
    current = '';
    } else {
    current += char;
    }
    }
    result.push(current.trim());
    return result.map(val => val.startsWith('"') && val.endsWith('"') ? val.slice(1, -1).replace(/""/g, '"') : val);
    }

    async function fetchScheduleData() {
    try {
    const response = await fetch(`${scheduleApiUrl}&t=${new Date().getTime()}`);
    if (!response.ok) throw new Error(`Falha na busca dos dados (código: ${response.status})`);

    const csvText = await response.text();
    const lines = csvText.trim().replace(/\r/g, "").split('\n').slice(1);

    allScheduleData = lines.map(line => {
    const columns = parseCsvLine(line);
    
    // ### PASSO 2: LÓGICA DE LEITURA PARA 3 COLUNAS ###
    if (columns.length < 3) return null;
    
    const [dateStr, title, description] = columns;
    
    if (!dateStr || !title) return null;

    const dateParts = dateStr.split('/');
    if (dateParts.length !== 3) return null;
    
    const isoDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
    
    // ### PASSO 3: EXTRAÇÃO INTELIGENTE DO RESPONSÁVEL E COR ###
    let technician = '';
    let color = 'default';
    const technicianMatch = description.match(/\(([^)]+)\)/);
    if (technicianMatch) {
    technician = technicianMatch[1]; // Pega o texto de dentro dos parênteses
    const upperTech = technician.toUpperCase().split(',')[0]; // Pega só o primeiro nome se tiver vários
    color = technicianColors[upperTech] || 'default';
    }

    return {
    date: isoDate,
    title: title,
    description: description,
    technician: technician,
    color: color
    };
    }).filter(Boolean);
    
    } catch (error) {
    console.error("Erro no Cronograma:", error);
    tableBodyEl.innerHTML = `<tr><td colspan="7" class="text-center p-5"><div class="alert alert-danger mx-3"><strong>Erro ao carregar agenda:</strong> ${error.message}</div></td></tr>`;
    weekRangeEl.textContent = 'Erro ao carregar';
    }
    }

    function renderCalendarEvents(startDate) {
    let bodyHtml = '<tr>';
    const tempDate = new Date(startDate);
    let hasEventsThisWeek = false;

    for (let i = 0; i < 7; i++) {
    // Mantém a correção de fuso horário, essencial para o Brasil
    const year = tempDate.getFullYear();
    const month = String(tempDate.getMonth() + 1).padStart(2, '0');
    const day = String(tempDate.getDate()).padStart(2, '0');
    const dayString = `${year}-${month}-${day}`;

    const eventsForDay = allScheduleData.filter(event => event.date === dayString);
    
    bodyHtml += '<td>';
    if (eventsForDay.length > 0) {
    hasEventsThisWeek = true;
    
    // ### PASSO 4: EXIBIÇÃO CORRETA DOS DADOS EXTRAÍDOS ###
    eventsForDay.forEach(event => {
    bodyHtml += `
    <div class="schedule-event event-${event.color}" data-bs-toggle="tooltip" title="${event.description.replace(/"/g, '&quot;')}">
    <span class="event-title">${event.title}</span>
    <span class="event-details">${event.description.split('\n')[0]}</span>
    ${event.technician ? `<span class="event-details event-technician"><i class="bi bi-person-fill"></i> ${event.technician}</span>` : ''}
    </div>`;
    });
    }
    bodyHtml += '</td>';
    tempDate.setDate(tempDate.getDate() + 1);
    }
    bodyHtml += '</tr>';
    tableBodyEl.innerHTML = bodyHtml;

    if (!hasEventsThisWeek) {
    tableBodyEl.innerHTML = `<tr><td colspan="7" class="text-center text-muted p-5">Não há eventos agendados para esta semana.</td></tr>`;
    }

    [...tableBodyEl.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(el => new bootstrap.Tooltip(el));
    }
    
    function updateCalendarWeek(date) {
    const dayOfWeek = date.getDay();
    const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
    const startOfWeek = new Date(date.getFullYear(), date.getMonth(), diff);

    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);

    weekRangeEl.textContent = `Semana: ${startOfWeek.toLocaleDateString(locale, { day: '2-digit', month: 'long' })} - ${endOfWeek.toLocaleDateString(locale, { day: '2-digit', month: 'long', year: 'numeric' })}`;

    let headerHtml = '<tr>';
    const tempDateHeader = new Date(startOfWeek);
    const displayWeekDays = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
    
    for (let i = 0; i < 7; i++) {
    headerHtml += `<th>${displayWeekDays[i]} (${tempDateHeader.toLocaleDateString(locale, { day: '2-digit', month: '2-digit' })})</th>`;
    tempDateHeader.setDate(tempDateHeader.getDate() + 1);
    }
    headerHtml += '</tr>';
    tableHeadEl.innerHTML = headerHtml;

    renderCalendarEvents(startOfWeek);
    }

    weekRangeEl.textContent = 'Carregando agenda...';
    tableBodyEl.innerHTML = `<tr><td colspan="7"><div class="loading-spinner active" style="padding: 4rem 0;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-3 text-muted">Buscando dados da agenda...</p></div></td></tr>`;
    
    await fetchScheduleData();
    updateCalendarWeek(currentDate);

    prevBtn.addEventListener('click', (e) => {
    e.preventDefault();
    currentDate.setDate(currentDate.getDate() - 7);
    updateCalendarWeek(new Date(currentDate));
    });

    nextBtn.addEventListener('click', (e) => {
    e.preventDefault();
    currentDate.setDate(currentDate.getDate() + 7);
    updateCalendarWeek(new Date(currentDate));
    });
    }
    </script>
</body>
</html>
